---
/**
 * LanguageSwitcher - Dropdown language selector
 * 
 * Usage:
 * ---
 * import LanguageSwitcher from '@pagebase/kit/components/LanguageSwitcher.astro';
 * ---
 * <LanguageSwitcher locale="de" />
 * 
 * Or with custom URLs:
 * <LanguageSwitcher locale="de" urls={{ de: '/de/', en: '/en/' }} />
 */

import type { Locale } from '../content';

interface Props {
  /** Current locale */
  locale: Locale;
  /** Custom URLs for each language (optional - auto-generated if not provided) */
  urls?: Record<Locale, string>;
  /** Variant: 'dropdown' (desktop) or 'buttons' (mobile) */
  variant?: 'dropdown' | 'buttons';
  /** Label for mobile buttons section */
  label?: string;
  /** Additional classes */
  class?: string;
}

const {
  locale,
  urls,
  variant = 'dropdown',
  label,
  class: className = '',
} = Astro.props;

// Auto-generate language switch URLs if not provided
const langUrls = urls ?? {
  de: locale === 'de' ? Astro.url.pathname : Astro.url.pathname.replace(/^\/en(\/|$)/, '/de$1'),
  en: locale === 'en' ? Astro.url.pathname : Astro.url.pathname.replace(/^\/de(\/|$)/, '/en$1'),
};

const languages = [
  { code: 'de' as Locale, name: 'Deutsch' },
  { code: 'en' as Locale, name: 'English' },
];

const uniqueId = `lang-${Math.random().toString(36).substr(2, 9)}`;
---

{variant === 'dropdown' ? (
  <div class:list={['relative', className]} id={`${uniqueId}-dropdown`}>
    <button
      type="button"
      id={`${uniqueId}-toggle`}
      class="flex items-center gap-1 px-2 py-1.5 text-sm text-text-light hover:text-text transition-colors rounded border border-transparent hover:border-border"
      aria-expanded="false"
      aria-haspopup="true"
    >
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
      </svg>
      <span class="uppercase font-medium">{locale}</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
      </svg>
    </button>
    <div
      id={`${uniqueId}-menu`}
      class="absolute right-0 mt-1 w-32 bg-white border border-border rounded-lg shadow-lg py-1 hidden z-50"
    >
      {languages.map((lang) => (
        <a
          href={langUrls[lang.code]}
          class:list={[
            'block px-4 py-2 text-sm transition-colors',
            locale === lang.code 
              ? 'bg-primary/10 text-primary font-medium' 
              : 'text-text-light hover:bg-surface hover:text-text'
          ]}
        >
          {lang.name}
        </a>
      ))}
    </div>
  </div>
  <script define:vars={{ uniqueId }}>
    (function() {
      const toggle = document.getElementById(`${uniqueId}-toggle`);
      const menu = document.getElementById(`${uniqueId}-menu`);
      if (!toggle || !menu) return;

      toggle.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = !menu.classList.contains('hidden');
        menu.classList.toggle('hidden');
        toggle.setAttribute('aria-expanded', String(!isOpen));
      });

      document.addEventListener('click', function() {
        if (!menu.classList.contains('hidden')) {
          menu.classList.add('hidden');
          toggle.setAttribute('aria-expanded', 'false');
        }
      });
    })();
  </script>
) : (
  <div class:list={[className]}>
    {label && <p class="text-xs text-text-light uppercase tracking-wide mb-2">{label}</p>}
    <div class="flex gap-3">
      {languages.map((lang) => (
        <a
          href={langUrls[lang.code]}
          class:list={[
            'px-3 py-1.5 rounded text-sm transition-colors',
            locale === lang.code 
              ? 'bg-primary text-white' 
              : 'bg-surface text-text-light hover:text-text'
          ]}
        >
          {lang.name}
        </a>
      ))}
    </div>
  </div>
)}
